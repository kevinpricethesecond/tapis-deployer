#!/bin/bash

echo "burnup tenants:"

mkdir -p {{ tapisdatadir }}/tenants
mkdir -p {{ tapisdatadir }}/tenants/postgres
mkdir -p {{ tapisdatadir }}/tenants/pgadmin

export postgres_password=`grep DBCREDENTIAL_POSTGRES_TENANTS_POSTGRES_TENANTS_TENANTS_PASSWORD {{ tapisdatadir }}/skadmin/env | awk -F= '{print $2}' | tr -d " \t\n\r"`
export POSTGRES_PASSWORD=`grep DBCREDENTIAL_POSTGRES_TENANTS_POSTGRES_TENANTS_TENANTS_PASSWORD {{ tapisdatadir }}/skadmin/env | awk -F= '{print $2}' | tr -d " \t\n\r"`
export service_password=`grep SERVICEPWD_TENANTS_PASSWORD {{ tapisdatadir }}/skadmin/env | awk -F= '{print $2}' | tr -d " \t\n\r"`
export admin_tenant_public_key=`grep JWTSIGNING_ADMIN_PUBLICKEY {{ tapisdatadir }}/skadmin/env | awk -F= '{print $2}' | tr -d " \t\n\r"`
export dev_tenant_public_key=`grep JWTSIGNING_DEV_PUBLICKEY {{ tapisdatadir }}/skadmin/env | awk -F= '{print $2}' | tr -d " \t\n\r"`

docker compose up -d tenants-postgres

docker compose run --rm tenants-migrations upgrade

docker compose up -d tenants-api

